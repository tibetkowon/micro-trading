<div class="stock-detail">
    <!-- Header -->
    <div class="stock-header">
        <div class="stock-name">{{ stock_name }}</div>
        <div class="stock-symbol-label">{{ symbol }} &middot; {{ market }}</div>
    </div>

    <!-- Price Hero (auto-refresh) -->
    <div id="price-hero"
         hx-get="/partials/stock-price/{{ symbol }}?market={{ market }}"
         hx-trigger="load, every 10s"
         hx-swap="innerHTML">
        {% include "partials/stock_price_hero.html" %}
    </div>

    <!-- Daily Chart -->
    <div class="stock-chart-wrap">
        <canvas id="daily-chart" height="240"></canvas>
    </div>

    <!-- Order Form -->
    <div class="order-section">
        <div class="order-section-title">주문</div>

        <div class="side-toggle">
            <button class="side-btn buy active" onclick="setSide('BUY', this)">매수</button>
            <button class="side-btn sell" onclick="setSide('SELL', this)">매도</button>
        </div>

        <form id="order-form"
              hx-post="/orders/submit"
              hx-target="#order-result"
              hx-swap="innerHTML"
              hx-on::after-request="onOrderComplete(event)">
            <input type="hidden" name="symbol" value="{{ symbol }}">
            <input type="hidden" name="market" value="{{ market }}">
            <input type="hidden" name="side" id="order-side" value="BUY">

            <div class="order-form-grid">
                <div>
                    <label>주문유형</label>
                    <select name="order_type" id="inline-order-type" onchange="toggleLimitPrice(this)">
                        <option value="MARKET">시장가</option>
                        <option value="LIMIT">지정가</option>
                    </select>
                </div>
                <div>
                    <label>수량</label>
                    <input type="number" name="quantity" min="1" value="1" required>
                </div>
                <div class="full-width">
                    <label>지정가</label>
                    <input type="number" name="price" id="inline-limit-price" step="0.01" disabled placeholder="시장가 주문">
                </div>
            </div>

            <button type="submit" class="order-submit-btn buy" id="order-submit-btn">매수 주문</button>
        </form>

        <div id="order-result"></div>
    </div>

    <!-- My Position for this stock -->
    <div id="stock-position"
         hx-get="/partials/stock-position/{{ symbol }}?market={{ market }}"
         hx-trigger="load, every 15s"
         hx-swap="innerHTML">
    </div>
</div>

<script>
(function() {
    // Load daily chart
    fetch(`/api/market/daily-prices/${encodeURIComponent('{{ symbol }}')}?market=${encodeURIComponent('{{ market }}')}`)
        .then(r => r.json())
        .then(data => {
            if (!data || !data.length) return;
            const ctx = document.getElementById('daily-chart');
            if (!ctx) return;

            // Destroy existing chart if any
            if (window._dailyChart) {
                window._dailyChart.destroy();
            }

            window._dailyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [{
                        label: '종가',
                        data: data.map(d => d.close),
                        borderColor: '#58a6ff',
                        backgroundColor: 'rgba(88,166,255,0.05)',
                        borderWidth: 1.5,
                        tension: 0.2,
                        fill: true,
                        pointRadius: 0,
                        pointHitRadius: 8,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => Number(ctx.parsed.y).toLocaleString()
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#6e7681', maxTicksLimit: 8, font: { size: 10 } },
                            grid: { color: '#21262d' }
                        },
                        y: {
                            ticks: {
                                color: '#6e7681',
                                font: { size: 10 },
                                callback: v => Number(v).toLocaleString()
                            },
                            grid: { color: '#21262d' }
                        }
                    },
                    interaction: { intersect: false, mode: 'index' }
                }
            });
        })
        .catch(() => {});
})();
</script>
